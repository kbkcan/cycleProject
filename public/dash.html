<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Dashboard">
    <meta name="keyword" content="Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">

    <title>CYCLE DASH</title>

    <!-- TODO 1. firebase SDK 링크 -->
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-database.js"></script>
    
    <!-- Custom -->
    <script src="index.js"></script>
    <script src="fireinit.js"></script>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    
    <!--external css-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="assets/css/zabuto_calendar.css">
    <link rel="stylesheet" type="text/css" href="assets/js/gritter/css/jquery.gritter.css" />
    <link rel="stylesheet" type="text/css" href="assets/lineicons/style.css">
    <link rel="stylesheet" type="text/css" href="assets/css/theme.css">

    <!-- Custom styles for this template -->
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="assets/css/style-responsive.css" rel="stylesheet">

    <script src="assets/js/chart-master/Chart.js"></script>
    
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
    #serverstatus01{
        width: 200px !important;
        height: 100px !important;
    }
    #clock{
        border: 1px solid #dedede;
        width: 100%;
        height: 99px;
        line-height: 73px;
        color: #666;
        font-size: 100px;
        text-align: center;
    }
    .stat>div {
        height: 2em;
        font-size: 14px !important;
        font-weight: bold;
    }
    .stat-img{
        font-size:50px !important;
    }
    </style>
  </head>

  <body>
  <section id="container" >
      <!-- **********************************************************************************************************************************************************
      TOP BAR CONTENT & NOTIFICATIONS
      *********************************************************************************************************************************************************** -->
      <!--header start-->
      <header class="header black-bg" style="position: fixed;">
              <div class="sidebar-toggle-box">
                  <div id="BTN_TOOLTIPS" class="fa fa-bars tooltips" data-placement="right" data-original-title="Toggle Navigation"></div>
              </div>
            <!--logo start-->
            <a href="./dash.html" class="logo"><b>CYCLE DASH</b></a>
            <!--logo end-->
            <div class="top-menu">
            	<ul class="nav pull-right top-menu">
                    <!-- 로그아웃, 마이페이지 버튼 -->
                    <li><a id="BTN_LOGOUT" type="button" class="logout" href="#" style="display: none;">Logout</a></li>
                    <!-- <li><a id="BTN_MYPAGE" type="button" class="logout" href="#" style="display: none;">마이페이지</a></li> -->
            	</ul>
            </div>
            <!-- <span id="AUTH_STATE" class="blue-text">(인증되지 않음)</span> -->
                
            <!-- 유저 정보 확인용 요소 추가 -->
            <!--
            <div>         
                <ol id="USER_INFO">
				  <li>UID : <span id="USER_UID" class="blue-text"></span></li>
				  <li>메일 : <span id="USER_MAIL" class="blue-text"></span></li>
				  <li>이름 : <span id="USER_NAME" class="blue-text"></span></li>
				  <li><img id="USER_PHOTO"></li>
                </ol> 
            </div>
            -->
		
        </header>
      <!--header end-->

      <!-- **********************************************************************************************************************************************************
      MAIN SIDEBAR MENU
      *********************************************************************************************************************************************************** -->
      <!--sidebar start-->
      <aside>
          <div id="sidebar"  class="nav-collapse ">
              <!-- sidebar menu start-->
              <ul class="sidebar-menu" id="nav-accordion">
              
              	  <p class="centered"><a href="#"><img src="assets/img/ui-sam.jpg" class="img-circle" width="60"></a></p>
              	  <h5 class="centered">Profile</h5>

                  <li class="mt"> 
                      <a class="" href="./dash.html">
                          <i class="fa fa-home"></i>
                          <span>홈</span>
                      </a>
                  </li>
                  <li class="mt">
                        <a class="" href="./mypage.html">
                            <i class="fa fa-user"></i>
                            <span>마이페이지</span>
                        </a>
                    </li>

                    <li class="sub-menu">
                        <a href="./statistics.html" >
                            <i class=" fa fa-chart-bar"></i>
                            <span>통계</span>
                        </a>
                    </li>

                  <li class="sub-menu">
                      <a href="javascript:;" >
                          <i class="fa fa-book"></i>
                          <span>Extra Pages</span>
                      </a>
                      <ul class="sub">
                          <li><a  href="blank.html">Blank Page</a></li>
                          <li><a  href="login.html">Login</a></li>
                          <li><a  href="lock_screen.html">Lock Screen</a></li>
                      </ul>
                  </li>
                  <li class="sub-menu">
                      <a href="javascript:;" >
                          <i class="fa fa-tasks"></i>
                          <span>Forms</span>
                      </a>
                      <ul class="sub">
                          <li><a  href="form_component.html">Form Components</a></li>
                      </ul>
                  </li>
                  <li class="sub-menu">
                      <a href="javascript:;" >
                          <i class="fa fa-th"></i>
                          <span>Data Tables</span>
                      </a>
                      <ul class="sub">
                          <li><a  href="basic_table.html">Basic Table</a></li>
                          <li><a  href="responsive_table.html">Responsive Table</a></li>
                      </ul>
                  </li>
              </ul>
              <!-- sidebar menu end-->
          </div>
      </aside>
      <!--sidebar end-->
      
      <!-- **********************************************************************************************************************************************************
      MAIN CONTENT
      *********************************************************************************************************************************************************** -->
      <!--main content start-->
      <section id="main-content">
            <section class="wrapper">
                        <!-- TWITTER PANEL -->
						<div class="col-md-4 mb">
                              <div class="darkblue-panel" style="background: none; height: 100%;">
                      			<div class="darkblue-header"><br> 
                                    <h3 style="color:#777777; font-weight: bold;">오늘 소모한 칼로리</h3>
                                      
                      			</div>
                                  <div class="row" style="display:inline-block !important;">
                                    <div class="col-xs-6">
                                        <canvas id="serverstatus01" style="width:200px; height:100px;"></canvas>
                                        <script>
                                                var doughnutData = [
                                                {
                                                    value: 0,
                                                    color: "#68dff0"
                                                },
                            
                                                {
                                                    value: 100,
                                                    color: "#444c57"
                                                }
                                            ];
                                                var myDoughnut = new Chart(document.getElementById("serverstatus01").getContext("2d")).Doughnut(doughnutData);
                                        </script>
                                    </div>
                                    <div class="col-xs-6" style="text-align: center; padding-top:13%;"> 
                                        <div style="color: #989898;" class="figure"><i class="fa fa-fire" style="font-size:1em"></i><span id="DB_kcal" style="font-size:1.1em; margin-left:5px;">0</span>
                                            <span style="font-size:1.1em;">Kcal</span></div>
                                    </div>
                                </div>
                            </div><!-- /col-md-4 -->
                        <div class="row">
                            <div class="col-lg-12 main-chart">
                                <div class="row mtbox">
                                    <div class="col-md-4 col-sm-4 col-xs-4 box0">
                                        <div class="box1 stat">
                                            <div>심박수</div>
                                            <span class="fa fa-heartbeat stat-img"></span>
                                            <div  style="font-size:1em; font-weight: bold;"><span style="font-size:1em; font-weight: bold; margin-top:14px;" id="DB_BPM">0</span>BPM</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 col-sm-4 col-xs-4 box0">
                                        <div class="box1 stat">
                                            <div>평균속도</div>
                                            <span class="fab fa-cloudscale stat-img"></span>
                                            <div style="font-size:1em; font-weight: bold;"><span style="font-size:1em; font-weight: bold; margin-top:14px;" id="DB_speed">0</span>Km/h</span></div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 col-sm-4 col-xs-4 box0">
                                        <div class="box1 stat">
                                            <div>거리</div>
                                            <span class="fas fa-bicycle stat-img"></span>
                                            <div style="font-size:1em; font-weight: bold;"><span style="font-size:1em; font-weight: bold; margin-top:14px;" id="DB_distance">0</span>Km</div>
                                        </div>
                                    </div>
                                </div><!-- /row mt -->
                                <div id="clock"><span style='font-size:50px;'>00:00:00</span></div>
                                    <div class="btn-group btn-group-justified" role="group">
                                        <a  class="btn btn-success" id="startPlay" onclick="startPlay();">운동시작</a >
                                            <a  class="btn btn-warning disabled" id="pause" onclick="pause()">일시정지</a >
                                            <a  class="btn btn-danger disabled" id="endPlay" onclick="endPlay();">운동종료</a >
                                    </div>
                                </div>
                            </div><!-- /col-lg-9 END SECTION MIDDLE -->
                        </div>
                    </div>
                </section>
            </section>
      <!--main content end-->
        </section>

    <!-- js placed at the end of the document so the pages load faster -->
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/jquery-1.8.3.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script class="include" type="text/javascript" src="assets/js/jquery.dcjqaccordion.2.7.js"></script>
    <script src="assets/js/jquery.scrollTo.min.js"></script>
    <script src="assets/js/jquery.nicescroll.js" type="text/javascript"></script>
    <script src="assets/js/jquery.sparkline.js"></script>

    <!--common script for all pages-->
    <script src="assets/js/common-scripts.js"></script>
    
    <script type="text/javascript" src="assets/js/gritter/js/jquery.gritter.js"></script>
    <script type="text/javascript" src="assets/js/gritter-conf.js"></script>

    <!--script for this page-->
    <script src="assets/js/sparkline-chart.js"></script>    
	<script src="assets/js/zabuto_calendar.js"></script>	

    <script type="text/javascript"> 

    /* 파이어 베이스 인증 */
    firebase.auth().onAuthStateChanged(function (user) {
            if (user) { // 인증되었을 때
                $('#AUTH_STATE').text(user.displayName + "님 로그인 하셨습니다.");
                $('#BTN_LOGOUT').show();
                $('#USER_NAME').text(user.displayName);
                $('#USER_MAIL').text(user.email);
                $('#USER_UID').text(user.uid);
                $('#USER_PHOTO').attr('src', user.photoURL);
                $('#USER_INFO').show();
            } else { // 인증되지 않았을 때
                $('#AUTH_STATE').text("(인증되지 않음)");
                $('#BTN_LOGOUT').hide();
                $('#USER_INFO').hide();
            }
        });
        // /* TODO 2. DB에서 '/메세지'값 읽어오기 */
        firebase.database().ref('/user/BPM').on('value', function(snapshot) {
                //debugger;
                var message = snapshot.val();
                messsage= message+'BPM'
                $("#DB_BPM").text(message);
        });


    var oneSecIntervalId = null; //1초 타이머ID
    var tenSecIntervalId = null; //10초 타이머ID
    var a_rate = null; //목표달성률
    var strStartAt = null // 시작한 시간 문자열
    var playTime = null;  //운동한 시간
    var user = null; // 사용자 객체변수

    function startPlay(){
      
        var btn_startPlay = document.getElementById('startPlay');
        var btn_pause = document.getElementById('pause');
        var btn_endPlay = document.getElementById('endPlay');
        //시작(비활성화) , 일시정지(활성화) , 운동 끝(활성화) 
        btn_startPlay.classList.add('disabled');
        btn_pause.classList.remove('disabled');
        btn_endPlay.classList.remove('disabled');

        //현재시간을 문자열로 만듦
        var startAt = new Date();
        strStartAt = dateToString(startAt);

        //운동시간을 0으로 초기화
        oneSecIntervalId = printClock(0,1000);

        //그래프를 초기화
        drawDonut(0,100);

        //칼로리를 0으로 초기화
        $('#DB_kcal').text(0);

        
        firebase.database().ref('/user').once('value').then(function(snapshot) {
            data = snapshot.val();    
            
            //User를 생성
            user = new User();
            user.weight= data['weight'];
            user.bike = data['bike'];  

            //log를 생성
            var newLog = new Log();
            newLog.startAt=startAt;
            log = newLog;
            playing(newLog,user);
        });
    }
    


    function playing(log,user) {
        tenSecIntervalId = startTimerToCheck(user);
    };

    function endPlay(){
        var btn_startPlay = document.getElementById('startPlay');
        var btn_pause = document.getElementById('pause');
        var btn_endPlay = document.getElementById('endPlay');
         //시작(비활성화) , 일시정지(활성화) , 운동 끝(활성화) 
        btn_startPlay.classList.remove('disabled');
        btn_pause.classList.add('disabled');
        btn_endPlay.classList.add('disabled');

        //firebase애 있는 운동시간을 업데이트한다.
        updateEndTimeAndExerciseTime();
        firebase.database().ref('/user/stopFlag').set(1);

        setTimeout(function(){
            clearInterval(oneSecIntervalId);
            clearInterval(tenSecIntervalId);
        }, 0);
    }

    
    var pauseFlag = 0  // 0 => 일시정지한 상태 , 1=> 다시 시작한 상태
     /* 일시정지버튼  클릭 시 */
    function pause(){
        var btn_startPlay = document.getElementById('startPlay');
        var btn_pause = document.getElementById('pause');
        var btn_endPlay = document.getElementById('endPlay');
        
        btn_startPlay.classList.add('disabled');
        btn_pause.classList.remove('disabled');
        btn_endPlay.classList.remove('disabled');
        
        if(pauseFlag == 0){ //이어서하기를 누르면
            $('#pause').text('이어서하기');
            pauseFlag = 1;
            var ref ='/user/';
            firebase.database().ref(ref+'/pauseFlag').set(1);
            setTimeout(function(){
                clearInterval(oneSecIntervalId);
                clearInterval(tenSecIntervalId);
            }, 0); 

           
        }else if(pauseFlag == 1){ //일시정지를 누르면
            $('#pause').text('일시정지');
            pauseFlag =0;
            var ref ='/user/log/'+strStartAt;
            firebase.database().ref(ref+'/pauseFlag').set(0);
            oneSecIntervalId = printClock(playTime,1000);
            tenSecIntervalId=startTimerToCheck(user)

        }
        
        //끝나는 시간과 운동시간을 업데이트한다.
        updateEndTimeAndExerciseTime();
        
    };

    function startTimerToCheck(user){
        console.log(user);
        var initialCycle = 0;
        firebase.database().ref('/user/sumCycleCount').once('value').then(function(snapshot) {
            data = snapshot.val();  
            initialCycle = data;
        });
        var intervalId = setInterval(function () {
            firebase.database().ref('/user').once('value').then(function(snapshot) {
            data = snapshot.val();  
            var sumCycleCount = parseInt(data['sumCycleCount']);
            var tenSecCycleCount = sumCycleCount - initialCycle;
            var targetKcal = parseInt(data['targetKcal']);
            log.targetKcal = targetKcal;    //목표 칼로리

            if(tenSecCycleCount != 0){

                //거리를 계산한다.
                log.distance=calDistance(user,tenSecCycleCount);
                log.sumDistance =log.sumDistance + log.distance; 
                $("#DB_distance").text(log.sumDistance.toFixed(2));
                
                
                //속도를 구한다.
                log.endAt = new Date();
                log.speed = calSpeed(log);
                $("#DB_speed").text(log.speed.toFixed(2));

                //평균속도별 칼로리계수를 구한다.
                log.indice = calIndice(log.speed);
                    
                //칼로리를 구한다.
                log.kcal = calKcal(log,user,tenSecCycleCount);
                
                //칼로리를 누적하고 초기화 한다..
                log.sumKcal = log.sumKcal+log.kcal;
                log.kcal = 0;
                $('#DB_kcal').text(log.sumKcal.toFixed(3));
                
                //현재 사이클 회수를 초기 사이클 회수로 바군다.
                initialCycle = sumCycleCount;
                
                //도넛을 그리면서 현재 목표달성률을 갱신한다.
                a_rate = drawDonut(log.sumKcal,log.targetKcal);
                log.a_rate = a_rate;
            
                updateFirebase(log);

            }else{
                $("#DB_speed").text(0);
            }
            });
        }, 10000);
        return intervalId;
    }


    function printClock(exerciseTime,duration) {
    
        var timeInterval = setInterval(function(){
            exerciseTime = exerciseTime + 1000;
            playTime = exerciseTime;
            var clock = document.getElementById("clock");   // 출력할 장소 선택
            var hours = parseInt(exerciseTime / (60*60*1000));
            exerciseTimeh = exerciseTime % (60*60*1000);
            var minutes = parseInt(exerciseTimeh / (60*1000));
            exerciseTimeM = exerciseTimeh % (60 * 1000);
            var seconds = parseInt(exerciseTimeM / 1000);
            clock.innerHTML = "<span style='font-size:50px;'>"+addZeros(hours,2)+":"+addZeros(minutes,2)+":"+addZeros(seconds,2) +" </span>"; //날짜를 출력해 줌
            var db_playTime = addZeros(hours,2)+":"+addZeros(minutes,2)+":"+addZeros(seconds,2)      
            },duration);         // 1초마다 printClock() 함수 호출
        

        return timeInterval;
    }

    
    
    function updateFirebase(log){
        console.log(log)
        var startTime = dateToString(log.startAt);
        var endAt = new Date();
        var strEndAt = dateToString(endAt);
        var ref ='/user/log/'+strStartAt;
        firebase.database().ref(ref+'/distance').set(log.sumDistance);
        firebase.database().ref(ref+'/kcal').set(log.sumKcal);
        firebase.database().ref(ref+'/endTime').set(strEndAt);
        firebase.database().ref(ref+'/speed').set(log.speed);
        firebase.database().ref(ref+'/targetkcal').set(log.targetKcal);
        firebase.database().ref(ref+'/exerciseTime').set(playTime);
        firebase.database().ref(ref+'/a_rate').set(log.a_rate);
    }

   
   /* 로그아웃 버튼을 눌렀을 때 인증 해제 하도록 하기 */
   $('#BTN_LOGOUT').click(function(){
     firebase.auth().signOut().then(function() {
       alert("인증이 해제되었습니다.");
       location.href = "./";
     }, function(error) {
       alert(error.message);
     });
   });

function drawDonut(sumKcal,targetKcal){
    var donutA = (sumKcal/targetKcal)*100;
    var donutB = 100-donutA;
    if(donutB<=0){
        alert('목표칼로리를 달성하셨습니다.');
        window.location.reload();
    }
    var doughnutData = [
    {
        value:donutA,
        color: "#68dff0"
    },
    {
        value: donutB,
        color: "#444c57"
    }
    ];
    var myDoughnut = new Chart(document.getElementById("serverstatus01").getContext("2d")).Doughnut(doughnutData);
    return donutA;
}

    function dateToString(date)
    {
        this.yyyy = date.getFullYear().toString();
        this.MM = (date.getMonth() + 1).toString();
        this.dd = date.getDate().toString();
        this.hh = date.getHours().toString();
        this.mm = date.getMinutes().toString();
        this.ss = date.getSeconds().toString();
        return yyyy + (MM[1] ? MM : '0'+ MM[0]) + (dd[1] ? dd : '0'+dd[0])+(hh[1] ? hh : '0'+hh[0])+(mm[1] ? mm : '0'+mm[0])+(ss[1] ? ss : '0'+ss[0]);
    }
    function addZeros(num, digit) { // 자릿수 맞춰주기
    var zero = '';
    num = num.toString();
    if (num.length < digit) {
        for (i = 0; i < digit - num.length; i++) {
        zero += '0';
        }
    }
    return zero + num;
}

function updateEndTimeAndExerciseTime(){
    var endAt = new Date();
    var strEndAt = dateToString(endAt);
    var ref ='/user/log/'+strStartAt;
    firebase.database().ref(ref+'/exerciseTime').set(playTime);
    firebase.database().ref(ref+'/endTime').set(strEndAt);
    firebase.database().ref(ref+'/a_rate').set(a_rate);
}

    function User(weight,bike){
        this.weight = weight;
        this.bike = bike;
    };
    
    function Log(){
        this.endAt = null;
        this.startAt = null;
        this.distance = 0;
        this.kcal = 0;
        this.indice = 0;
        this.speed = 0;
        this.sumKcal = 0;
        this.sumDistance = 0;
        this.targetKcal = 0;
        this.a_rate = 0;
    };

  
    
    function calKcal(log,user,cycleCount){
        //칼로리(kcal) = (몸무게 + 자전거무게) * 평속에 따른 소모열량지수 * 운동시간(분)
        var kcal = (user.weight + user.bike.bike_weight) * log.indice * (1/6);
        return kcal;
    };
    function calSpeed(log){
        var speed = log.distance/(1/360);
        //10초 = > 1/6 분 => (1/6)*(60)
        return speed;
    };
    function calDistance(user,cycleCount){
        distance = cycleCount * Math.PI *((user.bike.diameter/1000)/1000);
        return distance;
    };
    function calIndice(speed){
        if(speed<4){
            return 0;
        }else if(speed >= 4 && speed <= 12.9){
            return 0.065;
        }else if(speed > 12.9 && speed <= 16.1){
            return 0.0783;
        }else if(speed > 16.1 && speed <= 19.3){
            return 0.0939;
        }else if(speed > 19.3 && speed <= 22.5){
            return 0.1129;
        }else if(speed > 22.5 && speed <= 24.1){
            return 0.01237;
        }else if(speed > 24.1 && speed <= 25.7){
            return 0.1356;
        }else if(speed > 27.4 && speed <= 29){
            return 0.1488;
        }else if(speed > 29 && speed <= 30.6){
            return 0.1631;
        }else if(speed > 30.6 && speed <= 32.2){
            return 0.1788;
        }else if(speed > 32.2 && speed <= 33.8){
            return 0.1964;
        }else if(speed > 33.8 && speed <= 37){
            return 0.215;
        }else if(speed > 37 && speed <= 40.2){
            return 0.2586;
        }else{
            return 0.3111;
        }
    };


    function Bike(diameter,bike_weight){
        this.bike_weight = weight;
        this.diameter = diameter;
    }



    </script>
  </body>
</html>
